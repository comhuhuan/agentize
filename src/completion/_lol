#compdef lol

# Zsh completion for lol (AI-powered SDK CLI)
# Provides interactive command-line hints for lol subcommands and flags
# Supports: upgrade, project, plan, usage, version, serve, claude-clean

_lol() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    # Try to use lol --complete if available, fallback to static lists
    local -a commands
    if (( $+commands[lol] )); then
        # Dynamically fetch commands from lol --complete
        commands=( ${(f)"$(lol --complete commands 2>/dev/null)"} )
    fi

    # Fallback to static command list if dynamic fetch failed
    if (( ${#commands} == 0 )); then
        commands=(
            'claude-clean:Remove stale Claude config entries'
            'plan:Run multi-agent debate pipeline'
            'upgrade:Upgrade agentize installation'
            'project:Manage GitHub Projects v2 integration'
            'serve:Start polling server for GitHub Projects automation'
            'usage:Report Claude Code token usage statistics'
            'version:Display version information'
        )
    else
        # Add descriptions to dynamically fetched commands
        local -a commands_with_desc
        for cmd in $commands; do
            case $cmd in
                claude-clean) commands_with_desc+=('claude-clean:Remove stale Claude config entries') ;;
                plan) commands_with_desc+=('plan:Run multi-agent debate pipeline') ;;
                upgrade) commands_with_desc+=('upgrade:Upgrade agentize installation') ;;
                project) commands_with_desc+=('project:Manage GitHub Projects v2 integration') ;;
                serve) commands_with_desc+=('serve:Start polling server for GitHub Projects automation') ;;
                usage) commands_with_desc+=('usage:Report Claude Code token usage statistics') ;;
                version) commands_with_desc+=('version:Display version information') ;;
            esac
        done
        commands=( $commands_with_desc )
    fi

    _arguments -C \
        '1: :->command' \
        '*::arg:->args'

    case $state in
        command)
            _describe -t commands 'lol commands' commands
            ;;
        args)
            case $line[1] in
                claude-clean)
                    _lol_claude_clean
                    ;;
                plan)
                    _lol_plan
                    ;;
                upgrade)
                    _lol_upgrade
                    ;;
                project)
                    _lol_project
                    ;;
                serve)
                    _lol_serve
                    ;;
                usage)
                    _lol_usage
                    ;;
                version)
                    _lol_version
                    ;;
            esac
            ;;
    esac
}

# Completion for 'lol plan' subcommand
_lol_plan() {
    _arguments \
        '--dry-run[Skip GitHub issue creation; use timestamp-based artifacts]' \
        '--verbose[Print detailed stage logs]' \
        ':feature description:'
}

# Completion for 'lol upgrade' subcommand
_lol_upgrade() {
    # No flags or arguments for upgrade command
    return 0
}

# Completion for 'lol version' subcommand
_lol_version() {
    # No flags or arguments for version command
    return 0
}

# Completion for 'lol project' subcommand
_lol_project() {
    local -a project_modes project_create_flags project_automation_flags

    # Try dynamic fetch first
    if (( $+commands[lol] )); then
        project_modes=( ${(f)"$(lol --complete project-modes 2>/dev/null)"} )
        project_create_flags=( ${(f)"$(lol --complete project-create-flags 2>/dev/null)"} )
        project_automation_flags=( ${(f)"$(lol --complete project-automation-flags 2>/dev/null)"} )
    fi

    # Fallback to static flags
    if (( ${#project_modes} == 0 )); then
        project_modes=( '--create' '--associate' '--automation' )
    fi
    if (( ${#project_create_flags} == 0 )); then
        project_create_flags=( '--org' '--title' )
    fi
    if (( ${#project_automation_flags} == 0 )); then
        project_automation_flags=( '--write' )
    fi

    _arguments \
        '--create[Create new GitHub Projects v2 board]' \
        '--associate[Associate existing project board]:org/id:' \
        '--automation[Generate automation workflow template]' \
        '--org[GitHub organization]:organization:' \
        '--title[Project title]:title:' \
        '--write[Write automation template to file]:path:_files'
}

# Completion for 'lol usage' subcommand
_lol_usage() {
    local -a usage_flags

    # Try dynamic fetch first
    if (( $+commands[lol] )); then
        usage_flags=( ${(f)"$(lol --complete usage-flags 2>/dev/null)"} )
    fi

    # Fallback to static flags
    if (( ${#usage_flags} == 0 )); then
        usage_flags=( '--today' '--week' '--cache' '--cost' )
    fi

    _arguments \
        '--today[Show usage by hour for the last 24 hours]' \
        '--week[Show usage by day for the last 7 days]' \
        '--cache[Include cache token statistics]' \
        '--cost[Show cost estimate]'
}

# Completion for 'lol claude-clean' subcommand
_lol_claude_clean() {
    local -a claude_clean_flags

    # Try dynamic fetch first
    if (( $+commands[lol] )); then
        claude_clean_flags=( ${(f)"$(lol --complete claude-clean-flags 2>/dev/null)"} )
    fi

    # Fallback to static flags
    if (( ${#claude_clean_flags} == 0 )); then
        claude_clean_flags=( '--dry-run' )
    fi

    _arguments \
        '--dry-run[Preview changes without modifying ~/.claude.json]'
}

# Completion for 'lol serve' subcommand
# Note: lol serve no longer accepts CLI flags
# Configuration is YAML-only: server.period and server.num_workers in .agentize.local.yaml
_lol_serve() {
    # No CLI flags - show message about YAML configuration
    _message "Configure server.period and server.num_workers in .agentize.local.yaml"
}

_lol "$@"
