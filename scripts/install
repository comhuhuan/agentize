#!/usr/bin/env bash
# Agentize installer script
# One-command installer that clones, initializes worktrees, and sets up shell integration

set -e

# Default values
DEFAULT_INSTALL_DIR="$HOME/.agentize"
DEFAULT_REPO_URL="https://github.com/SyntheSys-Lab/agentize.git"

# Parse arguments
INSTALL_DIR=""
REPO_SOURCE=""
SHOW_HELP=false

while [ $# -gt 0 ]; do
    case "$1" in
        --dir)
            INSTALL_DIR="$2"
            shift 2
            ;;
        --repo)
            REPO_SOURCE="$2"
            shift 2
            ;;
        --help)
            SHOW_HELP=true
            shift
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Show help and exit
if [ "$SHOW_HELP" = true ]; then
    cat <<'EOF'
Agentize Installer

Usage: install [OPTIONS]

Options:
  --dir <path>       Installation directory (default: $HOME/.agentize)
  --repo <url|path>  Git repository URL or local path (default: GitHub repo)
  --help             Display this help message

Description:
  Installs Agentize by cloning the repository, running setup, and providing
  shell RC integration instructions.

Examples:
  # Default installation
  ./install

  # Custom install directory
  ./install --dir ~/my-agentize

  # Install from local repository (for testing)
  ./install --repo /path/to/local/agentize --dir /tmp/test-install

Exit Codes:
  0  Installation successful
  1  Installation failed
EOF
    exit 0
fi

# Set defaults if not provided
INSTALL_DIR="${INSTALL_DIR:-$DEFAULT_INSTALL_DIR}"
REPO_SOURCE="${REPO_SOURCE:-$DEFAULT_REPO_URL}"

# Validate dependencies
echo "Checking dependencies..."
for cmd in git make bash; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Error: Required command '$cmd' not found" >&2
        echo "Please install $cmd and try again" >&2
        exit 1
    fi
done
echo "Dependencies OK"

# Check if install directory already exists
if [ -e "$INSTALL_DIR" ]; then
    # Check if it's a valid agentize installation (has setup.sh)
    if [ -f "$INSTALL_DIR/setup.sh" ]; then
        echo "Agentize is already installed at: $INSTALL_DIR"
        echo ""
        echo "To upgrade your installation, run:"
        echo "  source $INSTALL_DIR/setup.sh && lol upgrade"
        echo ""
        echo "To reinstall, remove the directory first:"
        echo "  rm -rf $INSTALL_DIR"
        exit 0
    else
        echo "Error: Install directory already exists but is not a valid agentize installation: $INSTALL_DIR" >&2
        echo "" >&2
        echo "Please remove the directory or choose a different location with --dir" >&2
        echo "  rm -rf $INSTALL_DIR" >&2
        exit 1
    fi
fi

# Clone repository
echo "Installing to: $INSTALL_DIR"

if [ -d "$REPO_SOURCE" ]; then
    # Local path - clone from local repository
    echo "Copying from local repository: $REPO_SOURCE"

    # Verify it's a valid git repository
    if ! git -C "$REPO_SOURCE" rev-parse --git-dir >/dev/null 2>&1; then
        echo "Error: Source is not a valid git repository" >&2
        exit 1
    fi

    if ! git clone "$REPO_SOURCE" "$INSTALL_DIR" >/dev/null 2>&1; then
        echo "Error: Failed to clone from local repository" >&2
        exit 1
    fi
else
    # Remote URL - clone from remote
    echo "Cloning from: $REPO_SOURCE"

    if ! git clone "$REPO_SOURCE" "$INSTALL_DIR" >/dev/null 2>&1; then
        echo "Error: Failed to clone repository" >&2
        exit 1
    fi
fi

echo "Repository cloned successfully"

# Run setup
echo "Running setup..."

if ! make -C "$INSTALL_DIR" setup >/dev/null 2>&1; then
    echo "Error: Failed to run setup" >&2
    echo "Command failed: make -C $INSTALL_DIR setup" >&2
    exit 1
fi

echo "Setup complete: $INSTALL_DIR/setup.sh"

# Optional: register local Claude plugin marketplace if claude is available
if command -v claude >/dev/null 2>&1; then
    echo "Registering Claude Code plugin..."
    claude plugin uninstall agentize@agentize >/dev/null 2>&1 || true
    claude plugin marketplace remove agentize >/dev/null 2>&1 || true
    claude plugin marketplace remove SyntheSys-Lab/agentize >/dev/null 2>&1 || true
    claude plugin marketplace add "$INSTALL_DIR" || true
    claude plugin install agentize@agentize || true
    echo "Claude plugin registered"
else
    echo "Note: 'claude' CLI not found; skipping plugin registration."
    echo "  To register later: claude plugin marketplace add $INSTALL_DIR"
fi

# Create user-wide .agentize.local.yaml if it doesn't exist
LOCAL_CONFIG_FILE="$HOME/.agentize.local.yaml"
if [ ! -f "$LOCAL_CONFIG_FILE" ]; then
    echo "Creating user-wide config: $LOCAL_CONFIG_FILE"
    cat > "$LOCAL_CONFIG_FILE" <<'YAML'
# Agentize Local Configuration
# This file is searched in: project root > $AGENTIZE_HOME > $HOME
# See docs/envvar.md for configuration reference

handsoff:
  enabled: true
  debug: false
  auto_permission: true

# Telegram approval (optional)
# telegram:
#   enabled: false
#   token: "your-bot-token"
#   chat_id: "your-chat-id"

# Server runtime (optional)
# server:
#   period: 5m
#   num_workers: 5
YAML
    echo "User-wide config created"
fi

# Print shell RC integration instructions
cat <<EOF

========================================
Installation Complete!
========================================

To enable agentize commands (wt, lol) in your shell, add this line to your
shell RC file (~/.bashrc, ~/.zshrc, etc.):

    source $INSTALL_DIR/setup.sh

Then restart your shell or run:

    source ~/.bashrc  # or ~/.zshrc

After that, you can use:
  - wt init, wt spawn, wt list, etc.
  - lol upgrade, lol project, lol usage, etc.

For more information:
  - Quick Start: $INSTALL_DIR/README.md
  - Documentation: $INSTALL_DIR/docs/

EOF

exit 0
